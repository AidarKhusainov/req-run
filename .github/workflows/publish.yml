# Publishes the plugin to JetBrains Marketplace on version tag pushes.
name: Publish
on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

jobs:
  publish:
    name: Publish Plugin
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false

      - name: Fetch Sources
        uses: ./.github/actions/setup-env
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.ref_name }}
          fetch-depth: 0
          cache-read-only: true

      - name: Ensure Tag Trigger
        run: |
          TAG=$(git tag --points-at "${{ github.event.workflow_run.head_sha }}" | head -n 1)
          if [ -z "$TAG" ]; then
            echo "No tag points to head SHA; refusing to publish."
            exit 1
          fi
          echo "ORG_GRADLE_PROJECT_pluginVersion=$TAG" >> "$GITHUB_ENV"

      - name: Publish Plugin
        env:
          PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
          CERTIFICATE_CHAIN: ${{ secrets.CERTIFICATE_CHAIN }}
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          PRIVATE_KEY_PASSWORD: ${{ secrets.PRIVATE_KEY_PASSWORD }}
        run: ./gradlew publishPlugin
