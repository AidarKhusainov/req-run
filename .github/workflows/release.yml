# Tag-based GitHub release: build, verify, generate notes, and publish artifacts.
name: Release
on:
  push:
    tags:
      - "*.*.*"

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  checks:
    name: Checks
    uses: ./.github/workflows/build_base.yml
    with:
      pluginVersion: ${{ github.ref_name }}
      runPluginVerifier: true
      runQodana: false
      runDependencyCheck: false
      uploadArtifacts: false
    secrets: inherit

  # Prepare GitHub release assets and a changelog PR.
  release:
    name: Release Assets
    needs: [ checks ]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:

      # Free GitHub Actions Environment Disk Space
      - name: Maximize Build Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false

      # Fetch sources to access local actions
      - name: Fetch Sources
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      # Set up Java/Gradle for release tasks
      - name: Setup Environment
        uses: ./.github/actions/setup-env
        with:
          cache-read-only: true
          plugin-version: ${{ github.ref_name }}

      # Prepare release notes from CHANGELOG.md
      - name: Prepare Release Notes
        run: |
          VERSION="${{ github.ref_name }}"
          RELEASE_NOTE="./build/tmp/release_note.txt"
          mkdir -p "$(dirname "$RELEASE_NOTE")"
          ./gradlew writeReleaseNotes -PchangelogVersion=$VERSION -PchangelogOutput=$RELEASE_NOTE --quiet --console=plain

      # Update the Unreleased section with the current release note
      - name: Patch Changelog
        id: changelog
        run: |
          RELEASE_NOTE="./build/tmp/release_note.txt"
          ./gradlew patchChangelog --release-note-file=$RELEASE_NOTE

          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # Build the plugin to attach artifacts to the GitHub release
      - name: Build Plugin
        run: ./gradlew buildPlugin

      # Create or update GitHub Release and upload artifacts
      - name: Publish GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          RELEASE_NOTE="./build/tmp/release_note.txt"

          if gh release view "$VERSION" >/dev/null 2>&1; then
            gh release edit "$VERSION" --title "$VERSION" --notes-file "$RELEASE_NOTE"
          else
            gh release create "$VERSION" --title "$VERSION" --notes-file "$RELEASE_NOTE"
          fi

          gh release upload "$VERSION" ./build/distributions/* --clobber

      # Create a pull request
      - name: Create Pull Request
        if: ${{ steps.changelog.outputs.changed == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ github.ref_name }}"
          BRANCH="changelog-update-$VERSION"
          LABEL="release changelog"

          git config user.email "action@github.com"
          git config user.name "GitHub Action"

          git checkout -b $BRANCH
          git commit -am "Changelog update - $VERSION"
          git push --set-upstream origin $BRANCH

          gh label create "$LABEL" \
            --description "Pull requests with release changelog update" \
            --force \
            || true

          gh pr create \
            --title "Changelog update - \`$VERSION\`" \
            --body "Current pull request contains patched \`CHANGELOG.md\` file for the \`$VERSION\` version." \
            --label "$LABEL" \
            --head $BRANCH
